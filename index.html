<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📊 Utilitățile Mele PWA v4.0</title>
    
    <!-- PWA CONFIGURATION -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Utilități PWA">
    
    <!-- LOAD EXTERNAL RESOURCES -->
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- SERVICE WORKER REGISTRATION - CORRECT -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('✅ PWA Service Worker înregistrat cu succes!', registration);
                        
                        // Handle updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('PWA Update available - reloading...');
                                    window.location.reload();
                                }
                            });
                        });
                    })
                    .catch(registrationError => {
                        console.log('❌ PWA Service Worker eșuat:', registrationError);
                    });
            });
        } else {
            console.log('Service Worker nu este suportat în acest browser');
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Utilitățile Mele PWA v4.0</h1>
            <div class="pwa-indicator" style="display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(45deg, #4CAF50, #2196F3); color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; margin: 10px 0;">
                📱 PWA instalabilă • 🔄 Sync bidirectional • 📊 Export Excel/PDF
            </div>
            <p>🔔 Reminder-uri pentru data 20 • 🚗 Mașină completă cu linkuri • 👨‍👩‍👧‍👦 Sincronizare familie</p>
        </div>

        <div class="status-bar" style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.9); padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
            <div class="family-code" style="display: flex; align-items: center; gap: 10px; font-weight: 600;">
                👨‍👩‍👧‍👦 Familie: <span id="familyCode">-</span>
                <button class="btn btn-info" onclick="setupFamily()">⚙️ Configurează</button>
            </div>
            <div class="sync-status disconnected" id="syncStatus" style="display: flex; align-items: center; gap: 8px; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; background: #f8d7da; color: #721c24;">
                🔴 Offline
            </div>
        </div>

        <div id="alerts"></div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('home')">🏠 Acasă</button>
            <button class="tab" onclick="showTab('meters')">📊 Contoare</button>
            <button class="tab" onclick="showTab('car')">🚗 Mașina</button>
            <button class="tab" onclick="showTab('reports')">📈 Rapoarte</button>
            <button class="tab" onclick="showTab('settings')">⚙️ Setări</button>
        </div>

        <!-- HOME TAB -->
        <div class="section active" id="home">
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>📊 Indexuri citite luna aceasta</h4>
                    <div class="value" id="indexesThisMonth">0/4</div>
                </div>
                <div class="stat-card">
                    <h4>⚠️ Reminder-uri active</h4>
                    <div class="value" id="activeReminders">0</div>
                </div>
                <div class="stat-card">
                    <h4>👨‍👩‍👧‍👦 Utilizatori conectați</h4>
                    <div class="value" id="connectedUsers">1</div>
                </div>
                <div class="stat-card">
                    <h4>💰 Estimare cost lunar</h4>
                    <div class="value" id="estimatedCost">- RON</div>
                </div>
            </div>

            <div class="card">
                <h3>🔔 Reminder-uri Active</h3>
                <div id="remindersList">
                    <p style="text-align: center; color: #666; padding: 20px;">Se încarcă...</p>
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-success" onclick="markAllRead()">✅ Marchează toate ca citite</button>
                <button class="btn btn-primary" onclick="showQuickIndex()">⚡ Index rapid</button>
                <button class="btn btn-warning" onclick="generateReport()">📋 Raport rapid</button>
                <button class="btn btn-info" onclick="syncNow()">🔄 Sincronizează acum</button>
                <button class="btn" onclick="installPWA()" id="installBtn" style="background: #9C27B0;">📱 Instalează App</button>
            </div>
        </div>

        <!-- METERS TAB -->
        <div class="section" id="meters">
            <div class="card">
                <h3>💧 Contoare Apă</h3>
                <div class="index-grid">
                    <div class="index-info">
                        <h4>Apometru Baie</h4>
                        <div class="index-last" id="waterBathLast">Ultimul: -</div>
                    </div>
                    <div class="index-current" id="waterBathCurrent">---</div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="addReading('waterBath')">📝 Citește</button>
                        <button class="btn btn-danger" onclick="deleteReading('waterBath')">🗑️</button>
                    </div>
                </div>
                <div class="index-grid">
                    <div class="index-info">
                        <h4>Apometru Bucătărie</h4>
                        <div class="index-last" id="waterKitchenLast">Ultimul: -</div>
                    </div>
                    <div class="index-current" id="waterKitchenCurrent">---</div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="addReading('waterKitchen')">📝 Citește</button>
                        <button class="btn btn-danger" onclick="deleteReading('waterKitchen')">🗑️</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>🔥 Gaz & Electricitate</h3>
                <div class="index-grid">
                    <div class="index-info">
                        <h4>Contor Gaz</h4>
                        <div class="index-last" id="gasLast">Ultimul: -</div>
                    </div>
                    <div class="index-current" id="gasCurrent">---</div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="addReading('gas')">📝 Citește</button>
                        <button class="btn btn-danger" onclick="deleteReading('gas')">🗑️</button>
                    </div>
                </div>
                <div class="index-grid">
                    <div class="index-info">
                        <h4>Contor Electricitate</h4>
                        <div class="index-last" id="electricLast">Ultimul: -</div>
                    </div>
                    <div class="index-current" id="electricCurrent">---</div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="addReading('electric')">📝 Citește</button>
                        <button class="btn btn-danger" onclick="deleteReading('electric')">🗑️</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CAR TAB -->
        <div class="section" id="car">
            <div class="card">
                <h3>🔧 Întreținere Mașină</h3>
                <div class="index-grid">
                    <div class="index-info">
                        <h4>Schimb Ulei</h4>
                        <div class="index-last" id="oilChangeLast">Ultima dată: -</div>
                        <small style="color: #666;">Recomandat la 6 luni sau 10.000 km</small>
                    </div>
                    <div class="index-current" id="oilChangeNext">--- zile</div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="updateOilChange()">🔧 Am schimbat</button>
                        <button class="btn btn-primary" onclick="editOilChange()">✏️ Editează</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>📄 Documente Auto - Cu linkuri pentru cumpărare/programare</h3>
                
                <!-- ITP -->
                <div class="index-grid">
                    <div class="index-info">
                        <h4>🔍 ITP (Inspecție Tehnică)</h4>
                        <div class="index-last" id="itpLast">Expirare: -</div>
                        <small style="color: #666;">Obligatoriu anual pentru mașini > 12 ani</small>
                    </div>
                    <div class="index-current" id="itpStatus">---</div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="updateITP()">📄 Actualizează</button>
                        <a href="https://itp.ro/programare" target="_blank" class="btn btn-info">🌐 Programează ITP</a>
                        <a href="https://www.rarom.ro/itp" target="_blank" class="btn" style="background: #6c757d;">📋 RAROM</a>
                    </div>
                </div>
                
                <!-- ROVINIETĂ -->
                <div class="index-grid">
                    <div class="index-info">
                        <h4>🛣️ Rovinietă</h4>
                        <div class="index-last" id="rovignetteLast">Expirare: -</div>
                        <small style="color: #666;">Obligatorie pentru drumuri naționale și autostrăzi</small>
                    </div>
                    <div class="index-current" id="rovignetteStatus">---</div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="updateRovignette()">📄 Actualizează</button>
                        <a href="https://roviniete.ro/" target="_blank" class="btn btn-success">🛒 Roviniete.ro (Oficial)</a>
                        <a href="https://www.emag.ro/rovinieta" target="_blank" class="btn btn-warning">🛍️ eMAG</a>
                        <a href="https://www.altex.ro/rovinieta" target="_blank" class="btn btn-info">🏪 Altex</a>
                    </div>
                </div>

                <!-- ASIGURARE RCA -->
                <div class="index-grid">
                    <div class="index-info">
                        <h4>🛡️ Asigurare RCA</h4>
                        <div class="index-last" id="insuranceLast">Expirare: -</div>
                        <small style="color: #666;">Obligatoriu și verificat de poliție</small>
                    </div>
                    <div class="index-current" id="insuranceStatus">---</div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="updateInsurance()">📄 Actualizează</button>
                        <a href="https://pago.ro/" target="_blank" class="btn btn-success">💳 Pago.ro (Recomandat)</a>
                        <a href="https://www.compario.ro/asigurari-rca/" target="_blank" class="btn btn-info">📊 Compario - Compară prețuri</a>
                        <a href="https://www.omniasig.ro/" target="_blank" class="btn" style="background: #6c757d;">🏢 Omniasig</a>
                    </div>
                </div>

                <!-- ASIGURARE CASCO -->
                <div class="index-grid">
                    <div class="index-info">
                        <h4>🛡️ Asigurare CASCO</h4>
                        <div class="index-last" id="cascoLast">Expirare: -</div>
                        <small style="color: #666;">Opțională - protecție completă (furt, calamități, etc.)</small>
                    </div>
                    <div class="index-current" id="cascoStatus">---</div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="updateCasco()">📄 Actualizează</button>
                        <a href="https://pago.ro/casco" target="_blank" class="btn btn-success">💳 Pago.ro CASCO</a>
                        <a href="https://www.compario.ro/asigurari-casco/" target="_blank" class="btn btn-info">📊 Compario CASCO</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- REPORTS TAB -->
        <div class="section" id="reports">
            <div class="card">
                <h3>📈 Grafic Consumuri</h3>
                <div class="chart-container">
                    <canvas id="consumptionChart" width="400" height="200"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>📊 Tabel Consumuri</h3>
                <div style="overflow-x: auto;">
                    <table class="consumption-table" id="consumptionTable">
                        <thead>
                            <tr>
                                <th>Luna</th>
                                <th>Apă Baie (mc)</th>
                                <th>Apă Bucătărie (mc)</th>
                                <th>Gaz (mc)</th>
                                <th>Electricitate (kWh)</th>
                                <th>Cost Total (RON)</th>
                            </tr>
                        </thead>
                        <tbody id="consumptionTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- EXPORT PROGRESS -->
            <div id="exportProgress" style="display: none; text-align: center; padding: 20px; background: rgba(255,255,255,0.9); border-radius: 12px; margin: 10px 0;">
                <h4 id="exportTitle">🔄 Se generează export...</h4>
                <div style="width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin: 10px 0;">
                    <div id="progressFill" style="height: 100%; background: linear-gradient(45deg, #4CAF50, #2196F3); width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <p id="exportMessage">Se procesează datele...</p>
            </div>

            <div class="quick-actions">
                <button class="btn btn-success" onclick="exportExcel()">📋 Export Excel Real</button>
                <button class="btn btn-danger" onclick="exportPDF()">📄 Export PDF Real</button>
                <button class="btn btn-info" onclick="shareReport()">📤 Partajează JSON</button>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div class="section" id="settings">
            <div class="card">
                <h3>👨‍👩‍👧‍👦 Setări Familie - Sync Bidirectional</h3>
                <div class="form-group">
                    <label>Cod Familie:</label>
                    <input type="text" id="familyCodeInput" placeholder="Introduceți codul familiei">
                    <small style="color: #666;">Partajați acest cod cu membrii familiei pentru sincronizare bidirectională în timp real</small>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveFamily()">💾 Salvează și pornește sync</button>
                    <button class="btn btn-warning" onclick="generateFamilyCode()">🔄 Generează cod nou</button>
                    <button class="btn btn-info" onclick="testSync()">🧪 Test sincronizare</button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(33, 150, 243, 0.1); border-radius: 8px;">
                    <h5>📡 Status Sincronizare:</h5>
                    <p id="syncDetails">Offline - configurați codul familiei pentru sincronizare</p>
                </div>
            </div>

            <div class="card">
                <h3>💰 Prețuri Utilități</h3>
                <div class="form-group">
                    <label>Preț apă (RON/mc):</label>
                    <input type="number" id="waterPrice" value="15.50" step="0.01">
                </div>
                <div class="form-group">
                    <label>Preț gaz (RON/mc):</label>
                    <input type="number" id="gasPrice" value="3.20" step="0.01">
                </div>
                <div class="form-group">
                    <label>Preț electricitate (RON/kWh):</label>
                    <input type="number" id="electricPrice" value="0.65" step="0.01">
                </div>
                <button class="btn btn-primary" onclick="savePrices()">💾 Salvează prețurile</button>
            </div>

            <div class="card">
                <h3>📱 PWA - Aplicație Web Progresivă</h3>
                <p>Această aplicație poate fi instalată pe telefon/calculator ca o aplicație nativă.</p>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="installPWA()" id="installBtn2">📱 Instalează ca aplicație</button>
                    <button class="btn btn-info" onclick="checkPWAFeatures()">🔍 Verifică funcționalități PWA</button>
                </div>
                <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                    <p id="swStatus">🔄 Se verifică Service Worker...</p>
                    <p>✅ Manifest: Configurat</p>
                    <p>✅ Iconuri: SVG (compatibile)</p>
                    <p>✅ HTTPS: <span id="httpsStatus">Se verifică...</span></p>
                </div>
            </div>

            <div class="card">
                <h3>⚠️ Zona de Pericol</h3>
                <div class="btn-group">
                    <button class="btn btn-warning" onclick="resetReadings()">🔄 Resetează doar citirile</button>
                    <button class="btn btn-danger" onclick="factoryReset()">🏭 Factory Reset complet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FORM OVERLAY -->
    <div class="form-overlay" id="formOverlay">
        <div class="form-popup">
            <h3 id="formTitle">Adaugă Citire</h3>
            <div class="form-group">
                <label id="formLabel">Valoare:</label>
                <input type="number" id="formValue" placeholder="Introduceți valoarea">
            </div>
            <div class="form-group">
                <label>Data:</label>
                <input type="date" id="formDate">
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="saveReading()">💾 Salvează</button>
                <button class="btn" onclick="closeForm()" style="background: #666;">❌ Anulează</button>
            </div>
        </div>
    </div>

    <!-- LOAD MAIN SCRIPT -->
    <script src="script.js"></script>
    
    <script>
        // Verifică statusul PWA
        document.addEventListener('DOMContentLoaded', function() {
            // Check HTTPS
            const httpsStatus = document.getElementById('httpsStatus');
            if (httpsStatus) {
                httpsStatus.textContent = location.protocol === 'https:' ? 'Activ' : 'Inactiv (necesită HTTPS)';
            }
            
            // Check Service Worker
            const swStatus = document.getElementById('swStatus');
            if (swStatus) {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistration().then(registration => {
                        if (registration) {
                            swStatus.textContent = '✅ Service Worker: Activ';
                            swStatus.style.color = '#155724';
                        } else {
                            swStatus.textContent = '⏳ Service Worker: Se înregistrează...';
                            swStatus.style.color = '#856404';
                        }
                    });
                } else {
                    swStatus.textContent = '❌ Service Worker: Nu este suportat';
                    swStatus.style.color = '#721c24';
                }
            }
            
            console.log('📱 PWA Utilitățile Mele v4.0 încărcată cu succes!');
        });
    </script>
</body>
</html>
